# 조이스틱 매핑 업데이트 (2025-10-27)

## 변경 사항

### 아날로그 조이스틱 매핑 변경

#### 이전 매핑
- AN1 → 주행 전후진 (0x141, 0x142)
- AN2 → 주행 좌우 회전 (차동)
- AN3 → X축 이동 (0x144)
- AN4 → Z축 이동 (0x146)

#### 신규 매핑
- **AN3** → 하부체 전후진 (0x141, 0x142)
- **AN1** → 상부체 X축 전후 (0x144)
- **AN2** → 상부체 Y축 전후 (0x145)
- AN4 → (예비)

### 3단 스위치 기능 재정의

#### S19-S20: 모드 선택 (토글형)
- **S19 ON (상단)**: Remote Control 모드
- **중립**: 대기
- **S20 ON (하단)**: Automatic Control 모드

#### S17-S18: 횡이동 (엣지 트리거)
- **S17 ON→OFF**: 0x143 모터 +360도 회전 (+50mm 횡이동)
- **S18 ON→OFF**: 0x143 모터 -360도 회전 (-50mm 횡이동)

#### S21-S22: 작업 시퀀스 (엣지 트리거)

**S21 ON→OFF**: 그립 준비
1. Z축 100mm 하강
2. 그리퍼 닫기 (간격 0)

**S22 ON→OFF**: 결속 실행
1. 트리거 동작 (결속건 작동)
2. 그리퍼 열기 (간격 2000)
3. Z축 100mm 상승

#### S23-S24: Yaw 회전 (엣지 트리거)
- **S23 ON→OFF**: 0x147 모터 +30도 회전
- **S24 ON→OFF**: 0x147 모터 -30도 회전

## 3단 스위치 동작 원리

### 물리적 구조
```
┌────────────┐
│    상단    │ ← S19 ON (또는 S17, S21, S23)
├────────────┤
│    중립    │ ← 신호 없음
├────────────┤
│    하단    │ ← S20 ON (또는 S18, S22, S24)
└────────────┘
```

### 동작 모드

#### 1. 토글형 (S19-S20)
- 한쪽에 고정하여 모드 유지
- Remote 모드: 상단 고정 (S19=1)
- Automatic 모드: 하단 고정 (S20=1)

#### 2. 엣지 트리거형 (S17-S18, S21-S22, S23-S24)
- 스위치를 올리거나 내린 후 중립으로 복귀
- Rising Edge 감지: 0→1 전환 시에만 1회 동작
- 중립 복귀로 연속 입력 방지

### 코드 구현

```python
def switch_pressed(self, switch_name):
    """엣지 감지 (0→1 전환만)"""
    current = self.switch_data.get(switch_name, 0)
    previous = self.prev_switches.get(switch_name, 0)
    return current == 1 and previous == 0

# 제어 루프에서 이전 상태 저장
self.prev_switches = self.switch_data.copy()
```

## 파라미터 설정

```yaml
iron_md_teleop:
  ros__parameters:
    # 조이스틱
    max_linear_speed: 0.5       # m/s, 주행 최고속도
    max_angular_speed: 1.0      # rad/s, 회전 최고속도
    joystick_center: 127        # 조이스틱 중립값
    joystick_deadzone: 20       # 데드존
    
    # XYZ 스테이지
    xyz_step_size: 0.01         # m, 10mm/step (연속 제어)
    
    # 횡이동
    lateral_move_distance: 0.05 # m, 50mm (360도 회전)
    
    # 작업 시퀀스
    z_work_distance: 0.1        # m, 100mm (작업 높이)
    gripper_open_position: 0    # 그리퍼 닫힘
    gripper_close_position: 2000 # 그리퍼 열림
    
    # Yaw 회전
    yaw_rotation_angle: 30.0    # degrees, 30도 회전
    
    # 트리거
    trigger_duration: 0.5       # seconds, 트리거 지속시간
```

## 작업 시퀀스 예시

### 결속 작업 흐름

1. **접근** (조이스틱)
   - AN3: 하부체를 결속점까지 이동
   - AN1, AN2: 상부체 XY 위치 조정

2. **그립 준비** (S21)
   - Z축 하강 → 그리퍼 닫기
   - 철근 고정

3. **결속 실행** (S22)
   - 트리거 → 결속건 작동
   - 그리퍼 열기 → Z축 상승
   - 다음 결속점으로 이동 준비

4. **각도 조정** (필요 시)
   - S23/S24: Yaw 회전 (±30도)

5. **횡이동** (구역 변경 시)
   - S17/S18: 하부체 횡이동 (±50mm)

## 안전 기능

### 모드 전환
- Remote 모드: 조종기가 완전한 제어권 보유
- Automatic 모드: 상위제어 패키지에 제어권 위임
- 모드 전환 시 로그 출력

### 비상 정지
- Emergency Stop 버튼: 모든 모터 즉시 정지
- E-Stop 해제 시에만 동작 재개

### 송신기 연결 감시
- TX_Connected 비트 확인
- 연결 끊김 시 모든 모터 정지

## 주의사항

### 3단 스위치 사용
1. **엣지 트리거 스위치는 중립 복귀 필수**
   - S17-S18, S21-S22, S23-S24
   - 동작 후 즉시 중립으로 복귀해야 1회만 실행됨

2. **모드 스위치는 고정**
   - S19-S20
   - 사용할 모드에 따라 한쪽에 고정

3. **작업 시퀀스 주의**
   - S21 (그립) → S22 (결속) 순서 엄수
   - 역순 동작 시 예기치 않은 결과 발생 가능

### 하드웨어 호환성
- Iron-MD 조종기 CAN 연결 필수 (can1, 250Kbps)
- 3단 스위치 6세트 (S17-S18, S19-S20, S21-S22, S23-S24) 확인

## 테스트 체크리스트

- [ ] AN3 주행 전후진 확인
- [ ] AN1 X축 이동 확인
- [ ] AN2 Y축 이동 확인
- [ ] S19 Remote 모드 전환
- [ ] S20 Automatic 모드 전환
- [ ] S17 횡이동 +50mm
- [ ] S18 횡이동 -50mm
- [ ] S21 그립 준비 시퀀스
- [ ] S22 결속 실행 시퀀스
- [ ] S23 Yaw +30도
- [ ] S24 Yaw -30도
- [ ] 비상 정지 기능
- [ ] TX 연결 감시

## 문제 해결

### 조이스틱이 반응하지 않음
```bash
# CAN 메시지 확인
candump can1

# 0x1E4 메시지 수신되는지 확인
# 조이스틱 움직일 때 값 변경 확인
```

### 스위치가 계속 실행됨
- 스위치가 중립으로 복귀했는지 확인
- candump로 스위치 비트 상태 확인 (0x2E4)

### 모드 전환 안됨
- S19 또는 S20이 확실히 ON 되었는지 확인
- 다른 쪽 스위치가 OFF인지 확인

## 참고 문서
- [Iron-MD CAN 사양](./IRON_MD_GUIDE.md)
- [통합 가이드](./INTEGRATION_GUIDE.md)
- [RMD 모터 제어](../../rmd_robot_control/README.md)
